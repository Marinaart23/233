<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover">
    <title>–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π 3D-—Ö–æ–ª—Å—Ç</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: #000; 
            touch-action: none; 
        }
        canvas { 
            display: block; 
            position: fixed; 
            top: 0; 
            left: 0; 
        }
        #ui {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 100;
        }
        button {
            padding: 12px 20px;
            background: rgba(30, 30, 30, 0.7);
            color: white;
            border: 1px solid #555;
            border-radius: 8px;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
</head>
<body>
    <div id="ui">
        <button id="cameraBtn">üì∑ –ö–∞–º–µ—Ä–∞</button>
        <button id="imageBtn">üñº –§–æ—Ç–æ</button>
        <button id="clearBtn">‚ùå –û—á–∏—Å—Ç–∏—Ç—å</button>
    </div>
    <input type="file" id="fileInput" accept="image/*" style="display: none;">

    <script>
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ü–µ–Ω—ã
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x000000);
        
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 15;
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // 2. –û—Ä–±–∏—Ç–∞–ª—å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª–ª—ã (–¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏)
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.screenSpacePanning = true;

        // 3. –†–∏—Å–æ–≤–∞–Ω–∏–µ
        let currentLine = null;
        let lines = [];
        let isDrawing = false;

        // –î–∞–≤–ª–µ–Ω–∏–µ Apple Pencil
        function getLineWidth(e) {
            return e.pressure ? e.pressure * 4 : 2;
        }

        renderer.domElement.addEventListener('pointerdown', (e) => {
            e.preventDefault();
            isDrawing = true;
            
            const material = new THREE.LineBasicMaterial({ 
                color: 0xffffff, 
                linewidth: getLineWidth(e) 
            });
            const geometry = new THREE.BufferGeometry();
            currentLine = new THREE.Line(geometry, material);
            scene.add(currentLine);
            lines.push(currentLine);
        }, { passive: false });

        renderer.domElement.addEventListener('pointermove', (e) => {
            e.preventDefault();
            if (!isDrawing || !currentLine) return;
            
            const mouse = new THREE.Vector2(
                (e.clientX / window.innerWidth) * 2 - 1,
                -(e.clientY / window.innerHeight) * 2 + 1
            );
            
            const raycaster = new THREE.Raycaster();
            raycaster.setFromCamera(mouse, camera);
            const point = raycaster.ray.origin.clone();
            
            const positions = currentLine.geometry.attributes.position?.array || [];
            currentLine.geometry.setFromPoints([...positions, point]);
        }, { passive: false });

        renderer.domElement.addEventListener('pointerup', () => {
            isDrawing = false;
            saveDrawing();
        });

        // 4. –ü–æ–¥–ª–æ–∂–∫–∞ (–∫–∞–º–µ—Ä–∞/—Ñ–æ—Ç–æ)
        document.getElementById('cameraBtn').addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                const video = document.createElement('video');
                video.srcObject = stream;
                video.playsInline = true;
                video.muted = true;
                video.play();
                
                const texture = new THREE.VideoTexture(video);
                const plane = new THREE.Mesh(
                    new THREE.PlaneGeometry(20, 20),
                    new THREE.MeshBasicMaterial({ map: texture })
                );
                plane.position.z = -10;
                scene.add(plane);
            } catch (err) {
                alert("–†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Safari.");
            }
        });

        document.getElementById('imageBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });

        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const texture = new THREE.TextureLoader().load(event.target.result);
                const plane = new THREE.Mesh(
                    new THREE.PlaneGeometry(20, 20),
                    new THREE.MeshBasicMaterial({ map: texture })
                );
                plane.position.z = -10;
                scene.add(plane);
            };
            reader.readAsDataURL(file);
        });

        // 5. –û—á–∏—Å—Ç–∫–∞ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        document.getElementById('clearBtn').addEventListener('click', () => {
            lines.forEach(line => scene.remove(line));
            lines = [];
            localStorage.removeItem('savedDrawing');
        });

        function saveDrawing() {
            const linesData = lines.map(line => line.geometry.attributes.position.array);
            localStorage.setItem('savedDrawing', JSON.stringify(linesData));
        }

        function loadDrawing() {
            const savedData = localStorage.getItem('savedDrawing');
            if (!savedData) return;
            
            JSON.parse(savedData).forEach(data => {
                const material = new THREE.LineBasicMaterial({ color: 0xffffff });
                const geometry = new THREE.BufferGeometry();
                geometry.setFromPoints(data.map((v, i) => 
                    i % 3 === 0 ? new THREE.Vector3(v, data[i+1], data[i+2]) : null
                ).filter(Boolean));
                const line = new THREE.Line(geometry, material);
                scene.add(line);
                lines.push(line);
            });
        }

        // 6. –ó–∞–ø—É—Å–∫
        loadDrawing();
        
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
